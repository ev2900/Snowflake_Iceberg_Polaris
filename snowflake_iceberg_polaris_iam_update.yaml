Description: CloudFormation Deployment for reading/writing to Iceberg tables from Snowflake via. Polaris and reading via. GDC catalog federation
Parameters:
  PolarisCatalogIAMRole:
    Type: String
    Description: IAM user ARN from the Polaris catalog
    
  PolarisCatalogExternalId:
    Type: String
    Description: External Id from the Polaris catalog

  StorageIAMRole:
    Type: String
    Description: STORAGE_AWS_IAM_USER_ARN from the external volume
    
  StorageExternalId:
    Type: String
    Description: STORAGE_AWS_IAM_USER_ARN from the external volume
    
Resources:
  #
  # S3 Bucket
  #
  S3:
    Type: AWS::S3::Bucket

  #
  # Lambda Function IAM Role
  # 
  LambdaDownloadJarExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        # Imporvement required - premissions need to be scoped down
        - PolicyName: Admin
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: 
                  - '*'
                Resource: '*'
  #
  # Lambda Function to download Iceberg Jar files
  # 
  DownloadJARsScriptLambdaFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: 'Download-Iceberg-Jar-and-Glue-Script-Register-Table'
      Handler: index.lambda_handler
      Role: !GetAtt LambdaDownloadJarExecutionRole.Arn
      Runtime: python3.8
      Code:
        ZipFile: |
          
          import cfnresponse
          import urllib3
          import boto3
          import os
          
          def lambda_handler(event, context):
  
            s3 = boto3.client('s3')
            http = urllib3.PoolManager()

            print('-- Event below --')
            print(event)
            print('--')

            if event['RequestType'] == 'Create':
              try:
                # AWS Bundle
                print('Downloading AWS bundle JAR ...')
                response = http.request('GET', 'https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-aws-bundle/1.10.0/iceberg-aws-bundle-1.10.0.jar', timeout=urllib3.Timeout(connect=15.0, read=60.0))
                print("AWS bundle JAR download HTTP status " + str(response.status))
      
                if response.status == 200:
                  with open('/tmp/iceberg-aws-bundle-1.10.0.jar', 'wb') as f:
                    f.write(response.data)
                  os.sync()
          
                s3.upload_file('/tmp/iceberg-aws-bundle-1.10.0.jar', os.environ['S3_BUCKET_NAME'], 'jars/iceberg-aws-bundle-1.10.0.jar')
      
                # Iceberg
                print('Downloading Iceberg bundle JAR ...')
                response = http.request('GET', 'https://repo1.maven.org/maven2/org/apache/iceberg/iceberg-spark-runtime-3.5_2.12/1.10.0/iceberg-spark-runtime-3.5_2.12-1.10.0.jar', timeout=urllib3.Timeout(connect=15.0, read=60.0))
                print("Iceberg JAR download HTTP status " + str(response.status))
      
                if response.status == 200:
                  with open('/tmp/iceberg-spark-runtime-3.5_2.12-1.10.0.jar', 'wb') as f:
                    f.write(response.data)
                  os.sync()
          
                s3.upload_file('/tmp/iceberg-spark-runtime-3.5_2.12-1.10.0.jar', os.environ['S3_BUCKET_NAME'], 'jars/iceberg-spark-runtime-3.5_2.12-1.10.0.jar')
  
                # Glue Job Script
                copy_source = {
                  'Bucket': 'sharkech-public',
                  'Key': 'misc-public/create_iceberg_table.py'
                }
  
                s3.copy_object(CopySource = copy_source, Bucket = os.environ['S3_BUCKET_NAME'], Key = 'scripts/create_iceberg_table.py')

                # Return success status to cloudformation 
                responseData = {'Status': 'SUCCESS', 'StackId': event['StackId'], 'RequestId': event['RequestId'], 'LogicalResourceId': event['LogicalResourceId'], 'PhysicalResourceId': ''}
                cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)

                 # Return lambda response
                return {
                  'statusCode': 200,
                  'body': 'successfully download JAR files and glue script to S3'
                }
                
              except Exception as e:
                print('-- Error for create request type --')
                print(e)
                print('--')

                responseData = {'Status': 'FAILURE', 'StackId': event['StackId'], 'RequestId': event['RequestId'], 'LogicalResourceId': event['LogicalResourceId'], 'PhysicalResourceId': ''}
                cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)

                # Return lambda response
                return {
                  'statusCode': 400,
                  'body': 'failed to download JAR files and glue script to S3'
                }

            elif event['RequestType'] == 'Delete':
              try:
                s3 = boto3.resource('s3')
                bucket = s3.Bucket(os.environ['S3_BUCKET_NAME'])
              
                for prefix in ['jars', 'scripts', 'iceberg']:
                  objects_to_delete = bucket.objects.filter(Prefix=prefix)
                  objects_to_delete.delete()

                responseData = {'Status': 'SUCCESS', 'StackId': event['StackId'], 'RequestId': event['RequestId'], 'LogicalResourceId': event['LogicalResourceId'], 'PhysicalResourceId': ''}
                cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)
                
              except Exception as e:
                print('-- Error for delete request type --')
                print(e)
                print('--')

                responseData = {'Status': 'FAILURE', 'StackId': event['StackId'], 'RequestId': event['RequestId'], 'LogicalResourceId': event['LogicalResourceId'], 'PhysicalResourceId': ''}
                cfnresponse.send(event, context, cfnresponse.SUCCESS, responseData)

                # Return lambda response
                return {
                  'statusCode': 400,
                  'body': 'failed to delete files from S3'
                }          
      Timeout: 300
      MemorySize: 2048
      EphemeralStorage: 
        Size: 5120
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3
      
  #
  # Customer resource to execute the load CSV lambda function
  #
  DownloadJARsLambdaFunctionCustomResource:
    Type: AWS::CloudFormation::CustomResource
    DependsOn: DownloadJARsScriptLambdaFunction
    Version: 1.0
    Properties:
      ServiceToken: !GetAtt DownloadJARsScriptLambdaFunction.Arn


  #
  # Glue data catalog, database
  #
  GlueDatabase:
    Type: 'AWS::Glue::Database'
    Properties:
      CatalogId: !Ref 'AWS::AccountId'
      DatabaseInput:
        Name: 'iceberg'

  #
  # Glue Execution IAM Role
  # 
  GlueExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: glue.amazonaws.com
            Action: "sts:AssumeRole"
      Policies:
        # Imporvement required - premissions need to be scoped down
        - PolicyName: Admin
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: 
                  - '*'
                Resource: '*'

  #
  # Glue Jobs
  #
  IcebergGlueJob:
    Type: 'AWS::Glue::Job'
    Properties:
      Name: 'Create Iceberg Table'
      Role: !GetAtt GlueExecutionRole.Arn
      Command:
        Name: 'glueetl'
        ScriptLocation: !Join 
          - ''
          - - 's3://'
            - !Ref S3
            - '/scripts/create_iceberg_table.py'
        PythonVersion: '3'
      DefaultArguments:
        '--extra-jars': !Join
          - ''
          - - 's3://'
            - !Ref S3
            - '/jars/iceberg-aws-bundle-1.10.0.jar,'
            - 's3://'
            - !Ref S3
            - '/jars/iceberg-spark-runtime-3.5_2.12-1.10.0.jar'
        '--s3_bucket_name': !Ref S3
      MaxRetries: 0
      GlueVersion: '5.0'
      NumberOfWorkers: 2
      WorkerType: 'G.1X'
      Timeout: 2880
  
  #
  # Snowflake Polaris Catalog IAM Role
  # 
  SnowflakePolarisCatalogIAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Ref PolarisCatalogIAMRole
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Ref PolarisCatalogExternalId
      Policies:
        - PolicyName: Admin
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'
  
  #
  # Snowflake External Volume Storage IAM Role
  #
  SnowflakePolarisStorageIAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Ref StorageIAMRole
            Action: sts:AssumeRole
            Condition:
              StringEquals:
                sts:ExternalId: !Ref StorageExternalId
      Policies:
        - PolicyName: Admin
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: '*'
                Resource: '*'

  #
  # Lake Formation Connection Role
  #
  LakeFormationIAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: "lakeformation.amazonaws.com" 
            Action: sts:AssumeRole
          - Effect: Allow
            Principal:
              Service: "glue.amazonaws.com" 
            Action: sts:AssumeRole
      Policies:
        - PolicyName: Admin
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - '*'
                Resource: '*'

Outputs:
  SnowflakePolarisCatalogIAMRole:
    Description: Use this for s3 role ARN when creating the catalog in Polaris
    Value: !GetAtt SnowflakePolarisCatalogIAMRole.Arn

  SnowflakePolarisStorageIAMRole:
    Description: STORAGE_AWS_ROLE_ARN when creating the external volume
    Value: !GetAtt SnowflakePolarisStorageIAMRole.Arn

  StorageBaseUri:
    Description: Use this default base location when creating the catalog in Polaris and STORAGE_BASE_URL when creating the external volume
    Value: !Join 
      - ''
      - - 's3://'
        - !Ref S3

  LakeFormationIAMRole:
    Description: Use this for <lake-formation-IAM-role-ARN> value when creating the LakeFormation catalog federation via. the AWS CLI
    Value: !GetAtt LakeFormationIAMRole.Arn
